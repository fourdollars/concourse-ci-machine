#!/bin/bash
# OCI wrapper - injects dynamic /srv folder mounts

BUNDLE=""
PREV=""
for arg in "$@"; do
    if [[ "$PREV" == "--bundle" ]]; then
        BUNDLE="$arg"
        break
    fi
    PREV="$arg"
done

if [[ -n "$BUNDLE" ]] && [[ -f "$BUNDLE/config.json" ]]; then
    if [[ -d "/srv" ]]; then
        for folder in /srv/*; do
            if [[ -d "$folder" ]]; then
                FOLDER_NAME=$(basename "$folder")
                MOUNT_OPTIONS="rbind,ro"
                if [[ "$FOLDER_NAME" == *"_writable" ]] || [[ "$FOLDER_NAME" == *"_rw" ]]; then
                    MOUNT_OPTIONS="rbind,rw"
                fi
                
                TMP_CONFIG=$(mktemp "$BUNDLE/config.json.XXXXXX")
                if jq --arg dest "/srv/$FOLDER_NAME" \
                   --arg src "$folder" \
                   --arg opts "$MOUNT_OPTIONS" \
                   '.mounts += [{
                       "destination": $dest,
                       "type": "bind",
                       "source": $src,
                       "options": ($opts | split(","))
                   }]' "$BUNDLE/config.json" > "$TMP_CONFIG" 2>/dev/null; then
                    mv "$TMP_CONFIG" "$BUNDLE/config.json"
                else
                    rm -f "$TMP_CONFIG"
                fi
            fi
        done
    fi
fi

# Use bundled runc if available, fallback to system runc
RUNC_BIN="/opt/concourse/bin/runc.real"
if [[ ! -x "$RUNC_BIN" ]]; then
    RUNC_BIN="/usr/bin/runc.real"
fi
if [[ ! -x "$RUNC_BIN" ]]; then
    RUNC_BIN="/usr/bin/runc"
fi

exec "$RUNC_BIN" "$@"
