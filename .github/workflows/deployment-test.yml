name: Deployment Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-charm:
    name: Build charm
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup LXD
        uses: canonical/setup-lxd@v1
        with:
          channel: 5.21/stable

      - name: Build charm
        run: |
          sudo snap install charmcraft --classic
          charmcraft pack

      - name: Upload charm artifact
        uses: actions/upload-artifact@v4
        with:
          name: concourse-ci-machine-charm
          path: concourse-ci-machine_amd64.charm
          retention-days: 1

  test-all-mode:
    name: Test deployment-mode=all
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: build-charm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download charm artifact
        uses: actions/download-artifact@v4
        with:
          name: concourse-ci-machine-charm

      - name: Setup LXD
        uses: canonical/setup-lxd@v1
        with:
          channel: 5.21/stable

      - name: Configure LXD IPv6
        run: |
          lxc network set lxdbr0 ipv6.address none
          lxc network set lxdbr0 ipv6.dhcp false
          lxc network set lxdbr0 ipv6.nat false

      - name: Install Juju
        run: |
          sudo snap install juju --channel 3.6/stable
          sudo snap install juju-wait --classic

      - name: Bootstrap Juju
        run: juju bootstrap localhost test-controller --config test-mode=true

      - name: Add Juju Model
        run: juju add-model concourse-all

      - name: Deploy charms
        run: |
          juju deploy ./concourse-ci-machine_amd64.charm concourse-ci --config deployment-mode=all
          juju deploy postgresql --channel 16/stable

      - name: Relate charms
        run: juju relate concourse-ci:postgresql postgresql:database

      - name: Wait for model to settle
        run: juju-wait -m concourse-all -t 900

      - name: Juju Status
        run: juju status

      - name: Verify deployment
        run: |
          echo "=== Checking unit (should run both server and worker) ==="
          juju run concourse-ci/leader systemctl status concourse-server || echo "Server not running (unexpected)"
          juju run concourse-ci/leader systemctl status concourse-worker || echo "Worker not running (unexpected)"

      - name: Get admin password
        run: |
          juju run concourse-ci/leader get-admin-password | grep "password:" | awk '{print $2}' > admin-password.txt
          cat admin-password.txt

      - name: Get Concourse IP
        run: |
          juju status --format=json | jq -r '.applications."concourse-ci".units | to_entries[] | select(.value."leader" == true) | .value."public-address"' > concourse-ip.txt
          cat concourse-ip.txt

      - name: Install fly CLI
        run: |
          CONCOURSE_IP=$(cat concourse-ip.txt)
          curl -Lo fly "http://${CONCOURSE_IP}:8080/api/v1/cli?arch=amd64&platform=linux"
          chmod +x ./fly
          sudo mv ./fly /usr/local/bin/

      - name: Create test task
        run: |
          cat <<EOF > task.yml
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: busybox
          run:
            path: echo
            args: ["Hello from deployment-mode=all!"]
          EOF

      - name: Execute test task
        run: |
          export CONCOURSE_URL=$(cat concourse-ip.txt)
          export CONCOURSE_PASSWORD=$(cat admin-password.txt)
          fly -t ci login -c http://$CONCOURSE_URL:8080 -u admin -p $CONCOURSE_PASSWORD
          fly -t ci execute -c task.yml

      - name: Verify workers are registered
        run: |
          export CONCOURSE_URL=$(cat concourse-ip.txt)
          export CONCOURSE_PASSWORD=$(cat admin-password.txt)
          fly -t ci login -c http://$CONCOURSE_URL:8080 -u admin -p $CONCOURSE_PASSWORD
          fly -t ci workers
          WORKER_COUNT=$(fly -t ci workers | grep -c "running" || true)
          echo "Registered workers: $WORKER_COUNT"
          if [ "$WORKER_COUNT" -lt 1 ]; then
            echo "Expected at least 1 worker, found $WORKER_COUNT"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          juju destroy-model concourse-all --destroy-storage --force --no-wait -y || true

  test-auto-mode:
    name: Test deployment-mode=auto
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: build-charm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download charm artifact
        uses: actions/download-artifact@v4
        with:
          name: concourse-ci-machine-charm

      - name: Setup LXD
        uses: canonical/setup-lxd@v1
        with:
          channel: 5.21/stable

      - name: Configure LXD IPv6
        run: |
          lxc network set lxdbr0 ipv6.address none
          lxc network set lxdbr0 ipv6.dhcp false
          lxc network set lxdbr0 ipv6.nat false

      - name: Install Juju
        run: |
          sudo snap install juju --channel 3.6/stable
          sudo snap install juju-wait --classic

      - name: Bootstrap Juju
        run: juju bootstrap localhost test-controller --config test-mode=true

      - name: Add Juju Model
        run: juju add-model concourse-auto

      - name: Deploy charms (3 units in auto mode)
        run: |
          juju deploy ./concourse-ci-machine_amd64.charm concourse-ci --config deployment-mode=auto -n 3
          juju deploy postgresql --channel 16/stable

      - name: Relate charms
        run: juju relate concourse-ci:postgresql postgresql:database

      - name: Wait for model to settle
        run: juju-wait -m concourse-auto -t 900

      - name: Juju Status
        run: juju status

      - name: Verify deployment
        run: |
          echo "=== Checking leader (should run server) ==="
          juju run concourse-ci/leader systemctl status concourse-server || echo "Server not running on leader (unexpected)"
          
          echo "=== Checking non-leader unit (should run worker) ==="
          juju run concourse-ci/1 systemctl status concourse-worker || echo "Worker not running on unit 1"

      - name: Get admin password
        run: |
          juju run concourse-ci/leader get-admin-password | grep "password:" | awk '{print $2}' > admin-password.txt
          cat admin-password.txt

      - name: Get Concourse IP
        run: |
          juju status --format=json | jq -r '.applications."concourse-ci".units | to_entries[] | select(.value."leader" == true) | .value."public-address"' > concourse-ip.txt
          cat concourse-ip.txt

      - name: Install fly CLI
        run: |
          CONCOURSE_IP=$(cat concourse-ip.txt)
          curl -Lo fly "http://${CONCOURSE_IP}:8080/api/v1/cli?arch=amd64&platform=linux"
          chmod +x ./fly
          sudo mv ./fly /usr/local/bin/

      - name: Create test task
        run: |
          cat <<EOF > task.yml
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: busybox
          run:
            path: echo
            args: ["Hello from deployment-mode=auto!"]
          EOF

      - name: Execute test task
        run: |
          export CONCOURSE_URL=$(cat concourse-ip.txt)
          export CONCOURSE_PASSWORD=$(cat admin-password.txt)
          fly -t ci login -c http://$CONCOURSE_URL:8080 -u admin -p $CONCOURSE_PASSWORD
          fly -t ci execute -c task.yml

      - name: Verify workers are registered
        run: |
          export CONCOURSE_URL=$(cat concourse-ip.txt)
          export CONCOURSE_PASSWORD=$(cat admin-password.txt)
          fly -t ci login -c http://$CONCOURSE_URL:8080 -u admin -p $CONCOURSE_PASSWORD
          fly -t ci workers
          WORKER_COUNT=$(fly -t ci workers | grep -c "running" || true)
          echo "Registered workers: $WORKER_COUNT"
          if [ "$WORKER_COUNT" -lt 2 ]; then
            echo "Expected at least 2 workers, found $WORKER_COUNT"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          juju destroy-model concourse-auto --destroy-storage --force --no-wait -y || true

  test-web-worker-mode:
    name: Test deployment-mode=web+worker (with mounts)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: build-charm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download charm artifact
        uses: actions/download-artifact@v4
        with:
          name: concourse-ci-machine-charm

      - name: Setup LXD
        uses: canonical/setup-lxd@v1
        with:
          channel: 5.21/stable

      - name: Configure LXD IPv6
        run: |
          lxc network set lxdbr0 ipv6.address none
          lxc network set lxdbr0 ipv6.dhcp false
          lxc network set lxdbr0 ipv6.nat false

      - name: Install Juju
        run: |
          sudo snap install juju --channel 3.6/stable
          sudo snap install juju-wait --classic

      - name: Bootstrap Juju
        run: juju bootstrap localhost test-controller --config test-mode=true

      - name: Add Juju Model
        run: juju add-model concourse-ci

      - name: Deploy server and worker separately
        run: |
          juju deploy ./concourse-ci-machine_amd64.charm web --config deployment-mode=web
          juju deploy ./concourse-ci-machine_amd64.charm worker --config deployment-mode=worker -n 2
          juju deploy postgresql --channel 16/stable

      - name: Relate charms
        run: |
          juju relate web:postgresql postgresql:database
          juju relate worker:worker-tsa web:web-tsa

      - name: Wait for model to settle
        run: juju-wait -m concourse-ci -t 900

      - name: Juju Status
        run: juju status

      - name: Verify deployment
        run: |
          echo "=== Checking server unit ==="
          juju run web/leader systemctl status concourse-server || echo "Server not running (unexpected)"

          echo "=== Checking worker units ==="
          juju run worker/0 systemctl status concourse-worker || echo "Worker not running on unit 0"
          juju run worker/1 systemctl status concourse-worker || echo "Worker not running on unit 1"

      - name: Get admin password
        run: |
          juju run web/leader get-admin-password | grep "password:" | awk '{print $2}' > admin-password.txt
          cat admin-password.txt

      - name: Get Concourse server IP
        run: |
          juju status --format=json | jq -r '.applications.web.units | to_entries[] | select(.value."leader" == true) | .value."public-address"' > concourse-ip.txt
          cat concourse-ip.txt

      - name: Install fly CLI
        run: |
          CONCOURSE_IP=$(cat concourse-ip.txt)
          curl -Lo fly "http://${CONCOURSE_IP}:8080/api/v1/cli?arch=amd64&platform=linux"
          chmod +x ./fly
          sudo mv ./fly /usr/local/bin/

      - name: Prepare host mounts
        run: |
          mkdir -p /tmp/config-test-mount
          echo "config-test-marker" > /tmp/config-test-mount/marker.txt
          mkdir -p /tmp/config-test-mount-writable
          echo "config-test-writable-marker" > /tmp/config-test-mount-writable/marker.txt
          ls -lah /tmp/config-test-mount /tmp/config-test-mount-writable

      - name: Mount folders into worker containers
        run: |
          # Discover worker units and add per-container devices for mounts
          UNITS=$(juju status worker --format=json | jq -r '.applications.worker.units | keys[]' || true)
          if [ -z "$UNITS" ]; then echo "No worker units found"; exit 1; fi
          for UNIT in $UNITS; do
            MACHINE=$(juju status $UNIT --format=json | jq -r '.applications.worker.units["'"$UNIT"'"].machine')
            CONTAINER=$(lxc list --format=csv -c n | grep "^juju-.*-${MACHINE}$" | head -1)
            if [ -z "$CONTAINER" ]; then echo "No container for machine $MACHINE"; continue; fi
            echo "Adding mounts to $CONTAINER"
            # remove any existing devices with the same names
            lxc config device remove $CONTAINER config_test_ro || true
            lxc config device remove $CONTAINER config_test_rw || true
            # add a read-only mount
            lxc config device add $CONTAINER config_test_ro disk source="/tmp/config-test-mount" path="/srv/config_test" readonly=true
            # add a writable mount (suffix-based test)
            lxc config device add $CONTAINER config_test_rw disk source="/tmp/config-test-mount-writable" path="/srv/config_test_writable" readonly=false
          done

      - name: Create mount verification task
        run: |
          cat <<'EOF' > task.yml
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: busybox
          run:
            path: sh
            args:
              - -c
              - |
                echo "=== Listing /srv/config_test ==="
                ls -lah /srv/config_test || (echo "MOUNT_MISSING" && exit 2)
                echo "=== Showing marker file ==="
                cat /srv/config_test/marker.txt || (echo "FILE_MISSING" && exit 3)
                echo "=== Verifying read-only mount (touch should fail) ==="
                if touch /srv/config_test/write-test 2>/dev/null; then
                  echo "WRITE_SUCCEEDED (unexpected)"
                  exit 4
                else
                  echo "Confirmed read-only mount"
                fi
                echo "=== Listing /srv/config_test_writable ==="
                ls -lah /srv/config_test_writable || (echo "MOUNT_MISSING_WRITABLE" && exit 6)
                echo "=== Showing writable marker file ==="
                cat /srv/config_test_writable/marker.txt || (echo "FILE_MISSING_WRITABLE" && exit 7)
                echo "=== Verifying writable mount (touch should succeed) ==="
                if sh -c 'echo writable > /srv/config_test_writable/write-test' 2>/dev/null; then
                  echo "WRITE_SUCCEEDED on writable mount"
                else
                  echo "WRITE_FAILED on writable mount"
                  exit 5
                fi
          EOF

      - name: Execute mount verification task
        run: |
          export CONCOURSE_URL=$(cat concourse-ip.txt)
          export CONCOURSE_PASSWORD=$(cat admin-password.txt)
          fly -t ci login -c http://$CONCOURSE_URL:8080 -u admin -p $CONCOURSE_PASSWORD
          fly -t ci execute -c task.yml || (echo "Concourse task failed to see mount" && exit 1)

      - name: Cleanup
        if: always()
        run: |
          juju destroy-model concourse-ci --destroy-storage --force --no-wait -y || true
          rm -rf /tmp/config-test-mount || true
          rm -rf /tmp/config-test-mount-writable || true
