name: Deployment Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  test-all-mode:
    name: Test deployment-mode=all
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup LXD
        uses: canonical/setup-lxd@v1
        with:
          channel: 5.21/stable

      - name: Install Juju
        run: |
          sudo snap install juju --channel 3.6/stable
          sudo snap install juju-wait --classic

      - name: Bootstrap Juju
        run: sudo juju bootstrap localhost test-controller --config test-mode=true

      - name: Add Juju Model
        run: sudo juju add-model concourse-all

      - name: Build charm
        run: |
          sudo snap install charmcraft --classic
          sudo charmcraft pack
          sudo chown $USER:$USER concourse-ci-machine_amd64.charm

      - name: Deploy charms
        run: |
          sudo juju deploy $PWD/concourse-ci-machine_amd64.charm concourse-ci --config deployment-mode=all
          sudo juju deploy postgresql --channel 16/stable

      - name: Relate charms
        run: sudo juju relate concourse-ci:postgresql postgresql:database

      - name: Wait for model to settle
        run: sudo juju-wait -m concourse-all -t 900

      - name: Juju Status
        run: sudo juju status

      - name: Verify deployment
        run: |
          echo "=== Checking unit (should run both server and worker) ==="
          sudo juju run concourse-ci/leader systemctl status concourse-server || echo "Server not running (unexpected)"
          sudo juju run concourse-ci/leader systemctl status concourse-worker || echo "Worker not running (unexpected)"

      - name: Get admin password
        run: |
          sudo juju run concourse-ci/leader get-admin-password | grep "password:" | awk '{print $2}' > admin-password.txt
          cat admin-password.txt

      - name: Get Concourse IP
        run: |
          sudo juju status --format=json | jq -r '.applications."concourse-ci".units | to_entries[0].value.address' > concourse-ip.txt
          cat concourse-ip.txt

      - name: Install fly CLI
        run: |
          CONCOURSE_IP=$(cat concourse-ip.txt)
          curl -Lo fly "http://${CONCOURSE_IP}:8080/api/v1/cli?arch=amd64&platform=linux"
          chmod +x ./fly
          sudo mv ./fly /usr/local/bin/

      - name: Create test task
        run: |
          cat <<EOF > task.yml
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: busybox
          run:
            path: echo
            args: ["Hello from deployment-mode=all!"]
          EOF

      - name: Execute test task
        run: |
          export CONCOURSE_URL=$(cat concourse-ip.txt)
          export CONCOURSE_PASSWORD=$(cat admin-password.txt)
          fly -t ci login -c http://$CONCOURSE_URL:8080 -u admin -p $CONCOURSE_PASSWORD
          fly -t ci execute -c task.yml

      - name: Verify workers are registered
        run: |
          export CONCOURSE_URL=$(cat concourse-ip.txt)
          export CONCOURSE_PASSWORD=$(cat admin-password.txt)
          fly -t ci login -c http://$CONCOURSE_URL:8080 -u admin -p $CONCOURSE_PASSWORD
          fly -t ci workers
          WORKER_COUNT=$(fly -t ci workers | grep -c "running" || true)
          echo "Registered workers: $WORKER_COUNT"
          if [ "$WORKER_COUNT" -lt 1 ]; then
            echo "Expected at least 1 worker, found $WORKER_COUNT"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          sudo juju destroy-model concourse-all --destroy-storage --force --no-wait -y || true

  test-auto-mode:
    name: Test deployment-mode=auto
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup LXD
        uses: canonical/setup-lxd@v1
        with:
          channel: 5.21/stable

      - name: Install Juju
        run: |
          sudo snap install juju --channel 3.6/stable
          sudo snap install juju-wait --classic

      - name: Bootstrap Juju
        run: sudo juju bootstrap localhost test-controller --config test-mode=true

      - name: Add Juju Model
        run: sudo juju add-model concourse-auto

      - name: Build charm
        run: |
          sudo snap install charmcraft --classic
          sudo charmcraft pack
          sudo chown $USER:$USER concourse-ci-machine_amd64.charm

      - name: Deploy charms (3 units in auto mode)
        run: |
          sudo juju deploy $PWD/concourse-ci-machine_amd64.charm concourse-ci --config deployment-mode=auto -n 3
          sudo juju deploy postgresql --channel 16/stable

      - name: Relate charms
        run: sudo juju relate concourse-ci:postgresql postgresql:database

      - name: Wait for model to settle
        run: sudo juju-wait -m concourse-auto -t 900

      - name: Juju Status
        run: sudo juju status

      - name: Verify deployment
        run: |
          echo "=== Checking leader (should run server) ==="
          sudo juju run concourse-ci/leader systemctl status concourse-server || echo "Server not running on leader (unexpected)"
          
          echo "=== Checking non-leader unit (should run worker) ==="
          sudo juju run concourse-ci/1 systemctl status concourse-worker || echo "Worker not running on unit 1"

      - name: Get admin password
        run: |
          sudo juju run concourse-ci/leader get-admin-password | grep "password:" | awk '{print $2}' > admin-password.txt
          cat admin-password.txt

      - name: Get Concourse IP
        run: |
          sudo juju status --format=json | jq -r '.applications."concourse-ci".units | to_entries[] | select(.value."leader" == true) | .value.address' > concourse-ip.txt
          cat concourse-ip.txt

      - name: Install fly CLI
        run: |
          CONCOURSE_IP=$(cat concourse-ip.txt)
          curl -Lo fly "http://${CONCOURSE_IP}:8080/api/v1/cli?arch=amd64&platform=linux"
          chmod +x ./fly
          sudo mv ./fly /usr/local/bin/

      - name: Create test task
        run: |
          cat <<EOF > task.yml
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: busybox
          run:
            path: echo
            args: ["Hello from deployment-mode=auto!"]
          EOF

      - name: Execute test task
        run: |
          export CONCOURSE_URL=$(cat concourse-ip.txt)
          export CONCOURSE_PASSWORD=$(cat admin-password.txt)
          fly -t ci login -c http://$CONCOURSE_URL:8080 -u admin -p $CONCOURSE_PASSWORD
          fly -t ci execute -c task.yml

      - name: Verify workers are registered
        run: |
          export CONCOURSE_URL=$(cat concourse-ip.txt)
          export CONCOURSE_PASSWORD=$(cat admin-password.txt)
          fly -t ci login -c http://$CONCOURSE_URL:8080 -u admin -p $CONCOURSE_PASSWORD
          fly -t ci workers
          WORKER_COUNT=$(fly -t ci workers | grep -c "running" || true)
          echo "Registered workers: $WORKER_COUNT"
          if [ "$WORKER_COUNT" -lt 2 ]; then
            echo "Expected at least 2 workers, found $WORKER_COUNT"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          sudo juju destroy-model concourse-auto --destroy-storage --force --no-wait -y || true

  test-web-worker-mode:
    name: Test deployment-mode=web+worker
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup LXD
        uses: canonical/setup-lxd@v1
        with:
          channel: 5.21/stable

      - name: Install Juju
        run: |
          sudo snap install juju --channel 3.6/stable
          sudo snap install juju-wait --classic

      - name: Bootstrap Juju
        run: sudo juju bootstrap localhost test-controller --config test-mode=true

      - name: Add Juju Model
        run: sudo juju add-model concourse-split

      - name: Build charm
        run: |
          sudo snap install charmcraft --classic
          sudo charmcraft pack
          sudo chown $USER:$USER concourse-ci-machine_amd64.charm

      - name: Deploy server and worker separately
        run: |
          sudo juju deploy $PWD/concourse-ci-machine_amd64.charm web --config deployment-mode=web
          sudo juju deploy $PWD/concourse-ci-machine_amd64.charm worker --config deployment-mode=worker -n 2
          sudo juju deploy postgresql --channel 16/stable

      - name: Relate charms
        run: |
          sudo juju relate web:postgresql postgresql:database
          sudo juju relate worker:worker-tsa web:web-tsa

      - name: Wait for model to settle
        run: sudo juju-wait -m concourse-split -t 900

      - name: Juju Status
        run: sudo juju status

      - name: Verify deployment
        run: |
          echo "=== Checking server unit ==="
          sudo juju run web/leader systemctl status concourse-server || echo "Server not running (unexpected)"
          
          echo "=== Checking worker units ==="
          sudo juju run worker/0 systemctl status concourse-worker || echo "Worker not running on unit 0"
          sudo juju run worker/1 systemctl status concourse-worker || echo "Worker not running on unit 1"

      - name: Get admin password
        run: |
          sudo juju run web/leader get-admin-password | grep "password:" | awk '{print $2}' > admin-password.txt
          cat admin-password.txt

      - name: Get Concourse server IP
        run: |
          sudo juju status --format=json | jq -r '.applications.web.units | to_entries[0].value.address' > concourse-ip.txt
          cat concourse-ip.txt

      - name: Install fly CLI
        run: |
          CONCOURSE_IP=$(cat concourse-ip.txt)
          curl -Lo fly "http://${CONCOURSE_IP}:8080/api/v1/cli?arch=amd64&platform=linux"
          chmod +x ./fly
          sudo mv ./fly /usr/local/bin/

      - name: Create test task
        run: |
          cat <<EOF > task.yml
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: busybox
          run:
            path: echo
            args: ["Hello from deployment-mode=web+worker!"]
          EOF

      - name: Execute test task
        run: |
          export CONCOURSE_URL=$(cat concourse-ip.txt)
          export CONCOURSE_PASSWORD=$(cat admin-password.txt)
          fly -t ci login -c http://$CONCOURSE_URL:8080 -u admin -p $CONCOURSE_PASSWORD
          fly -t ci execute -c task.yml

      - name: Verify workers are registered
        run: |
          export CONCOURSE_URL=$(cat concourse-ip.txt)
          export CONCOURSE_PASSWORD=$(cat admin-password.txt)
          fly -t ci login -c http://$CONCOURSE_URL:8080 -u admin -p $CONCOURSE_PASSWORD
          fly -t ci workers
          WORKER_COUNT=$(fly -t ci workers | grep -c "running" || true)
          echo "Registered workers: $WORKER_COUNT"
          if [ "$WORKER_COUNT" -lt 2 ]; then
            echo "Expected at least 2 workers, found $WORKER_COUNT"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          sudo juju destroy-model concourse-split --destroy-storage --force --no-wait -y || true
