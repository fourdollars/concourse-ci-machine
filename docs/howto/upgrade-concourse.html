<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Upgrade or downgrade Concourse CI version safely">
    <title>Upgrade Concourse CI - Concourse CI Machine Charm</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <style>
        :root {
            --primary-color: #5c3c92;
            --secondary-color: #11a8cd;
            --accent-color: #fd5f00;
            --success-color: #0e8420;
            --warning-color: #f99b11;
            --text-dark: #111;
            --text-light: #666;
            --bg-light: #f7f7f7;
            --bg-white: #fff;
            --border-color: #d9d9d9;
            --tutorial-color: #5e2750;
            --howto-color: #206a5d;
            --reference-color: #216583;
            --explanation-color: #852c2b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Ubuntu', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background-color: var(--bg-white);
        }

        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 2rem;
            font-weight: 300;
        }

        .breadcrumbs {
            background: var(--bg-light);
            padding: 1rem 2rem;
            font-size: 0.9rem;
        }

        .breadcrumbs a {
            color: var(--howto-color);
            text-decoration: none;
        }

        .breadcrumbs a:hover {
            text-decoration: underline;
        }

        .content {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 2rem 4rem 2rem;
        }

        .edit-link {
            text-align: right;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .edit-link a {
            color: var(--secondary-color);
            text-decoration: none;
        }

        .edit-link a:hover {
            text-decoration: underline;
        }

        .content h1 {
            color: var(--howto-color);
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid var(--howto-color);
        }

        .content .subtitle {
            color: var(--text-light);
            font-size: 1.2rem;
            margin-bottom: 2rem;
            font-weight: 300;
        }

        .content h2 {
            color: var(--howto-color);
            font-size: 1.8rem;
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.3rem;
            border-bottom: 2px solid var(--border-color);
        }

        .content h3 {
            color: var(--text-dark);
            font-size: 1.3rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        .content p {
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        .content ul, .content ol {
            margin-bottom: 1rem;
            margin-left: 2rem;
        }

        .content li {
            margin-bottom: 0.5rem;
        }

        .content code {
            background: var(--bg-light);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }

        .content pre {
            background: #0d1117;
            color: #c9d1d9;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        .content pre code {
            background: none;
            padding: 0;
            color: inherit;
            font-size: 0.9rem;
        }

        .content a {
            color: var(--secondary-color);
            text-decoration: none;
        }

        .content a:hover {
            text-decoration: underline;
        }

        .note, .warning, .success {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border-left: 4px solid;
        }

        .note {
            background: #e7f2fa;
            border-color: var(--secondary-color);
        }

        .note strong {
            color: var(--secondary-color);
        }

        .warning {
            background: #fff4e6;
            border-color: var(--warning-color);
        }

        .warning strong {
            color: var(--warning-color);
        }

        .success {
            background: #e6f4ea;
            border-color: var(--success-color);
        }

        .success strong {
            color: var(--success-color);
        }

        footer {
            background: var(--bg-light);
            padding: 2rem;
            text-align: center;
            color: var(--text-light);
            margin-top: 4rem;
        }

        footer a {
            color: var(--primary-color);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        .footer-links {
            margin-top: 1rem;
        }

        .footer-links a {
            margin: 0 1rem;
        }

        @media (max-width: 768px) {
            .content {
                padding: 0 1rem 2rem 1rem;
            }

            header h1 {
                font-size: 1.5rem;
            }

            .content h1 {
                font-size: 2rem;
            }

            .content h2 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Concourse CI Machine Charm</h1>
        <p>Documentation</p>
    </header>

    <nav class="breadcrumbs">
        <a href="../index.html">Home</a> &gt; 
        <a href="../index.html#howto">How-To</a> &gt; 
        <span>Upgrade Concourse CI</span>
    </nav>

    <main class="content">
        <div class="edit-link">
            <a href="https://github.com/fourdollars/concourse-ci-machine/edit/main/docs/howto/upgrade-concourse.html">‚úèÔ∏è Edit on GitHub</a>
        </div>

        <h1>Upgrade Concourse CI</h1>
        <p class="subtitle">Change Concourse CI version (upgrade or downgrade)</p>

        <h2>Upgrade to Newer Version</h2>

        <pre><code class="language-bash"># Set new version
juju config concourse-ci version=7.14.3

# Monitor upgrade progress
juju status --watch 1s</code></pre>

        <p><strong>What happens:</strong></p>
        
        <!-- Upgrade Sequence Diagram -->
        <svg viewBox="0 0 900 550" xmlns="http://www.w3.org/2000/svg" style="max-width: 100%; height: auto; display: block; margin: 2rem auto;">
            <!-- Title -->
            <text x="450" y="30" text-anchor="middle" font-size="18" font-weight="bold" fill="#5c3c92">Automatic Upgrade Sequence (mode=auto)</text>
            
            <!-- Timeline -->
            <line x1="100" y1="70" x2="800" y2="70" stroke="#d9d9d9" stroke-width="2"/>
            <text x="100" y="60" text-anchor="middle" font-size="12" fill="#666">t=0s</text>
            <text x="800" y="60" text-anchor="middle" font-size="12" fill="#666">t=60s+</text>
            
            <!-- User Action -->
            <rect x="50" y="90" width="200" height="60" fill="#e8f4f8" stroke="#11a8cd" stroke-width="2" rx="6"/>
            <text x="150" y="115" text-anchor="middle" font-size="14" font-weight="bold" fill="#11a8cd">User Action</text>
            <text x="150" y="135" text-anchor="middle" font-size="12" fill="#333">juju config concourse-ci</text>
            <text x="150" y="150" text-anchor="middle" font-size="12" fill="#333">version=7.14.3</text>
            
            <!-- Step 1: Web Server Downloads -->
            <defs>
                <marker id="arrow-upgrade" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto">
                    <polygon points="0 0, 8 4, 0 8" fill="#f99b11"/>
                </marker>
            </defs>
            <path d="M 250 120 L 320 175" stroke="#f99b11" stroke-width="2" marker-end="url(#arrow-upgrade)"/>
            
            <rect x="320" y="175" width="220" height="80" fill="#fff4e6" stroke="#f99b11" stroke-width="3" rx="6"/>
            <text x="430" y="200" text-anchor="middle" font-size="14" font-weight="bold" fill="#f99b11">Step 1: Web Server (Leader)</text>
            <line x1="340" y1="208" x2="520" y2="208" stroke="#d9d9d9" stroke-width="1"/>
            <text x="430" y="225" text-anchor="middle" font-size="12" fill="#333">‚¨áÔ∏è Downloads v7.14.3</text>
            <text x="430" y="242" text-anchor="middle" font-size="12" fill="#333">üîÑ Restarts service</text>
            <text x="560" y="215" font-size="11" fill="#999">~10-30s</text>
            
            <!-- Step 2: Workers Detect Mismatch -->
            <defs>
                <marker id="arrow-detect" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto">
                    <polygon points="0 0, 8 4, 0 8" fill="#11a8cd"/>
                </marker>
            </defs>
            <path d="M 430 255 L 430 295" stroke="#11a8cd" stroke-width="2" marker-end="url(#arrow-detect)"/>
            <text x="450" y="280" font-size="11" fill="#11a8cd">Workers poll web</text>
            
            <rect x="120" y="295" width="200" height="70" fill="#e8f5e9" stroke="#0e8420" stroke-width="2" rx="6"/>
            <text x="220" y="318" text-anchor="middle" font-size="13" font-weight="bold" fill="#0e8420">Worker 1</text>
            <line x1="135" y1="325" x2="305" y2="325" stroke="#d9d9d9" stroke-width="1"/>
            <text x="220" y="340" text-anchor="middle" font-size="11" fill="#333">üîç Detects mismatch</text>
            <text x="220" y="355" text-anchor="middle" font-size="11" fill="#333">v7.12.1 ‚â† v7.14.3</text>
            
            <rect x="350" y="295" width="200" height="70" fill="#e8f5e9" stroke="#0e8420" stroke-width="2" rx="6"/>
            <text x="450" y="318" text-anchor="middle" font-size="13" font-weight="bold" fill="#0e8420">Worker 2</text>
            <line x1="365" y1="325" x2="535" y2="325" stroke="#d9d9d9" stroke-width="1"/>
            <text x="450" y="340" text-anchor="middle" font-size="11" fill="#333">üîç Detects mismatch</text>
            <text x="450" y="355" text-anchor="middle" font-size="11" fill="#333">v7.12.1 ‚â† v7.14.3</text>
            
            <rect x="580" y="295" width="200" height="70" fill="#e8f5e9" stroke="#0e8420" stroke-width="2" rx="6"/>
            <text x="680" y="318" text-anchor="middle" font-size="13" font-weight="bold" fill="#0e8420">Worker N</text>
            <line x1="595" y1="325" x2="765" y2="325" stroke="#d9d9d9" stroke-width="1"/>
            <text x="680" y="340" text-anchor="middle" font-size="11" fill="#333">üîç Detects mismatch</text>
            <text x="680" y="355" text-anchor="middle" font-size="11" fill="#333">v7.12.1 ‚â† v7.14.3</text>
            
            <!-- Step 3: Workers Auto-Upgrade -->
            <defs>
                <marker id="arrow-upgrade-worker" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto">
                    <polygon points="0 0, 8 4, 0 8" fill="#0e8420"/>
                </marker>
            </defs>
            <path d="M 220 365 L 220 405" stroke="#0e8420" stroke-width="2" marker-end="url(#arrow-upgrade-worker)"/>
            <path d="M 450 365 L 450 405" stroke="#0e8420" stroke-width="2" marker-end="url(#arrow-upgrade-worker)"/>
            <path d="M 680 365 L 680 405" stroke="#0e8420" stroke-width="2" marker-end="url(#arrow-upgrade-worker)"/>
            
            <rect x="120" y="405" width="200" height="70" fill="#e0f7fa" stroke="#00838f" stroke-width="2" rx="6"/>
            <text x="220" y="428" text-anchor="middle" font-size="12" font-weight="bold" fill="#00838f">Auto-Upgrade</text>
            <text x="220" y="445" text-anchor="middle" font-size="11" fill="#333">‚¨áÔ∏è Download v7.14.3</text>
            <text x="220" y="462" text-anchor="middle" font-size="11" fill="#333">üîÑ Restart service</text>
            
            <rect x="350" y="405" width="200" height="70" fill="#e0f7fa" stroke="#00838f" stroke-width="2" rx="6"/>
            <text x="450" y="428" text-anchor="middle" font-size="12" font-weight="bold" fill="#00838f">Auto-Upgrade</text>
            <text x="450" y="445" text-anchor="middle" font-size="11" fill="#333">‚¨áÔ∏è Download v7.14.3</text>
            <text x="450" y="462" text-anchor="middle" font-size="11" fill="#333">üîÑ Restart service</text>
            
            <rect x="580" y="405" width="200" height="70" fill="#e0f7fa" stroke="#00838f" stroke-width="2" rx="6"/>
            <text x="680" y="428" text-anchor="middle" font-size="12" font-weight="bold" fill="#00838f">Auto-Upgrade</text>
            <text x="680" y="445" text-anchor="middle" font-size="11" fill="#333">‚¨áÔ∏è Download v7.14.3</text>
            <text x="680" y="462" text-anchor="middle" font-size="11" fill="#333">üîÑ Restart service</text>
            
            <text x="810" y="440" font-size="11" fill="#999">~10-30s</text>
            <text x="810" y="455" font-size="11" fill="#999">per worker</text>
            
            <!-- Final State -->
            <rect x="300" y="495" width="300" height="40" fill="#e8f5e9" stroke="#0e8420" stroke-width="2" rx="6"/>
            <text x="450" y="520" text-anchor="middle" font-size="14" font-weight="bold" fill="#0e8420">‚úÖ All Units Running v7.14.3</text>
            
            <!-- Legend -->
            <text x="50" y="545" font-size="12" fill="#666">üí° <tspan font-weight="bold">Zero manual intervention</tspan> - Workers upgrade automatically!</text>
        </svg>

        <div class="success">
            <strong>‚úÖ Automatic worker upgrades:</strong> Workers automatically upgrade when they detect the web server is running a different version. No manual intervention needed!
        </div>

        <h2>Downgrade to Older Version</h2>

        <pre><code class="language-bash"># Set older version
juju config concourse-ci version=7.12.1

# Workers will automatically downgrade to match</code></pre>

        <div class="warning">
            <strong>‚ö†Ô∏è Database migrations:</strong> Downgrading may fail if the database schema changed between versions. Test in non-production first.
        </div>

        <h2>Upgrade from Latest (Auto-Detect)</h2>

        <p>When <code>version</code> is set to <code>latest</code> (default), the charm auto-detects the latest release from GitHub:</p>

        <pre><code class="language-bash"># Check current version
juju config concourse-ci version

# Force refresh to latest (if version=latest)
juju config concourse-ci version=latest</code></pre>

        <h2>Check Current Version</h2>

        <pre><code class="language-bash"># Via juju status
juju status concourse-ci
# Look for version in status message: "Web ready (v7.14.2)"

# Via configuration
juju config concourse-ci version

# Via Concourse CI web UI
# Open http://&lt;web-ip&gt;:&lt;port&gt; and check footer</code></pre>

        <h2>Distributed Mode (Separate Web/Worker Apps)</h2>

        <p>For distributed deployments, upgrade web first, then workers follow automatically:</p>

        <pre><code class="language-bash"># Upgrade web application
juju config web version=7.14.3

# Workers automatically upgrade via TSA relation
# Check worker status
juju status worker
# Should show: "Auto-upgrading Concourse CI to 7.14.3..."</code></pre>

        <h2>Monitor Upgrade Progress</h2>

        <pre><code class="language-bash"># Watch status updates
juju status --watch 1s

# Check logs
juju debug-log --include concourse-ci --tail

# For specific unit
juju debug-log --include concourse-ci/0 --replay --no-tail</code></pre>

        <p><strong>Status messages during upgrade:</strong></p>
        <ul>
            <li><code>Upgrading to v7.14.3...</code> - Download and installation in progress</li>
            <li><code>Auto-upgrading Concourse CI to 7.14.3...</code> - Worker detected version mismatch</li>
            <li><code>Web ready (v7.14.3)</code> - Upgrade complete</li>
        </ul>

        <h2>Rollback After Failed Upgrade</h2>

        <pre><code class="language-bash"># If upgrade fails, revert to previous version
juju config concourse-ci version=7.12.1

# Check logs for failure reason
juju debug-log --include concourse-ci --replay | grep -i error</code></pre>

        <h2>Shared Storage Mode Benefits</h2>

        <p>When using <a href="../tutorials/shared-storage-quickstart.html">shared storage</a>, upgrades are significantly faster:</p>

        <ul>
            <li><strong>Without shared storage:</strong> Each worker downloads ~90MB binary</li>
            <li><strong>With shared storage:</strong> Binary downloaded once, shared across all workers</li>
            <li><strong>Speed improvement:</strong> ~63% faster upgrades (measured with 3 workers)</li>
        </ul>

        <h2>Verify Upgrade Success</h2>

        <pre><code class="language-bash"># 1. Check all units are active
juju status concourse-ci

# 2. Verify web version
curl -s http://&lt;web-ip&gt;:8080/api/v1/info | jq .version

# 3. Check workers via Fly CLI
juju ssh concourse-ci/0
fly -t local workers
# All workers should show same version

# 4. Run a test pipeline
fly -t local execute -c test.yml</code></pre>

        <div class="note">
            <strong>üí° Best practice:</strong> Always test upgrades in a staging environment before applying to production.
        </div>

        <h2>Related Actions</h2>

        <ul>
            <li><a href="../tutorials/shared-storage-quickstart.html">Set Up Shared Storage</a> - Speed up upgrades by 63%</li>
            <li><a href="troubleshoot.html">Troubleshooting</a> - Fix common upgrade issues</li>
            <li><a href="../reference/configuration.html">Configuration Reference</a> - All available options</li>
        </ul>
    </main>

    <footer>
        <p>&copy; 2026 Concourse CI Machine Charm | Maintained by <a href="https://github.com/fourdollars">Shih-Yuan Lee (FourDollars)</a></p>
        <div class="footer-links">
            <a href="https://github.com/fourdollars/concourse-ci-machine">GitHub</a>
            <a href="https://charmhub.io/concourse-ci-machine">Charmhub</a>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
</body>
</html>
