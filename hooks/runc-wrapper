#!/bin/bash
# OCI wrapper - injects dynamic /srv folder mounts

BUNDLE=""
PREV=""
for arg in "$@"; do
    if [[ "$PREV" == "--bundle" ]]; then
        BUNDLE="$arg"
        break
    fi
    PREV="$arg"
done

if [[ -n "$BUNDLE" ]] && [[ -f "$BUNDLE/config.json" ]]; then
    if [[ -d "/srv" ]]; then
        for folder in /srv/*; do
            if [[ -d "$folder" ]]; then
                FOLDER_NAME=$(basename "$folder")
                MOUNT_OPTIONS="rbind,ro"
                if [[ "$FOLDER_NAME" == *"_writable" ]] || [[ "$FOLDER_NAME" == *"_rw" ]]; then
                    MOUNT_OPTIONS="rbind,rw"
                fi
                
                TMP_CONFIG="$BUNDLE/config.json.tmp"
                jq --arg dest "/srv/$FOLDER_NAME" \
                   --arg src "$folder" \
                   --arg opts "$MOUNT_OPTIONS" \
                   '.mounts += [{
                       "destination": $dest,
                       "type": "bind",
                       "source": $src,
                       "options": ($opts | split(","))
                   }]' "$BUNDLE/config.json" > "$TMP_CONFIG" 2>/dev/null
                
                if [[ $? -eq 0 ]]; then
                    mv "$TMP_CONFIG" "$BUNDLE/config.json"
                fi
            fi
        done
    fi
fi

exec /usr/bin/runc.real "$@"
