#!/bin/bash
# GPU wrapper for Concourse CI - injects NVIDIA_VISIBLE_DEVICES and dynamic /srv folder mounts

# Parse arguments to find bundle path
BUNDLE=""
PREV=""
for arg in "$@"; do
    if [[ "$PREV" == "--bundle" ]]; then
        BUNDLE="$arg"
        break
    fi
    PREV="$arg"
done

# If bundle found and config exists, inject GPU env vars and folder mounts
if [[ -n "$BUNDLE" ]] && [[ -f "$BUNDLE/config.json" ]]; then
    # Start with GPU env vars injection
    TMP_CONFIG="$BUNDLE/config.json.tmp"
    jq '.process.env += ["NVIDIA_VISIBLE_DEVICES=all", "NVIDIA_DRIVER_CAPABILITIES=all"]' \
        "$BUNDLE/config.json" > "$TMP_CONFIG" 2>/dev/null
    
    if [[ $? -eq 0 ]]; then
        mv "$TMP_CONFIG" "$BUNDLE/config.json"
    fi
    
    # Discover and inject all /srv folders
    if [[ -d "/srv" ]]; then
        for folder in /srv/*; do
            if [[ -d "$folder" ]]; then
                FOLDER_NAME=$(basename "$folder")
                
                # Determine if folder should be writable
                MOUNT_OPTIONS="rbind,ro"
                if [[ "$FOLDER_NAME" == *"_writable" ]] || [[ "$FOLDER_NAME" == *"_rw" ]]; then
                    MOUNT_OPTIONS="rbind,rw"
                fi
                
                # Inject mount into config.json
                jq --arg dest "/srv/$FOLDER_NAME" \
                   --arg src "$folder" \
                   --arg opts "$MOUNT_OPTIONS" \
                   '.mounts += [{
                       "destination": $dest,
                       "type": "bind",
                       "source": $src,
                       "options": ($opts | split(","))
                   }]' "$BUNDLE/config.json" > "$TMP_CONFIG" 2>/dev/null
                
                if [[ $? -eq 0 ]]; then
                    mv "$TMP_CONFIG" "$BUNDLE/config.json"
                fi
            fi
        done
    fi
fi

# Call nvidia-container-runtime which will inject GPU devices
exec /usr/bin/nvidia-container-runtime.real "$@"
