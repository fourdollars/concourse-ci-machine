# Implementation Plan: Shared Storage for Concourse CI Units

**Branch**: `001-shared-storage` | **Date**: 2026-01-09 | **Spec**: [spec.md](./spec.md)  
**Input**: Feature specification from `/specs/001-shared-storage/spec.md`

**Note**: This implementation plan is generated by the `/speckit.plan` command.

## Summary

Implement shared storage architecture for Concourse CI charm to eliminate redundant binary downloads across multiple units. The primary requirement is to configure Juju storage so that all Concourse units mount the same volume for binaries, reducing disk overhead from N×binary size to ~1.15× while maintaining per-unit worker data isolation.

**Technical Approach** (from Phase 0 research):
- Modify metadata.yaml storage configuration to support shared/pooled storage mode
- Implement file-based locking using Python's fcntl for concurrent write protection
- Update concourse_installer.py to detect existing binaries before downloading
- Add storage coordination logic to charm lifecycle events (install, config-changed, upgrade)
- Maintain backward compatibility with existing single-unit non-shared deployments

## Technical Context

**Language/Version**: Python 3.11+ (Ubuntu 24.04 base)  
**Primary Dependencies**: ops framework ≥2.0.0, fcntl (stdlib), pathlib (stdlib)  
**Storage**: Juju storage (filesystem-based, shared across units via pool configuration)  
**Testing**: pytest with ops.testing for unit tests, GitHub Actions for E2E deployment tests  
**Target Platform**: Ubuntu 24.04 LTS (Juju-managed machines/containers)  
**Project Type**: Single project (Juju charm with modular lib/ structure)  
**Performance Goals**: Binary download once per cluster, <3min unit addition with existing binaries  
**Constraints**: Filesystem-level locking only (no distributed coordination), POSIX-compliant filesystem required  
**Scale/Scope**: Support 1-10 units initially, extensible to larger deployments

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with constitution principles (v1.0.1):

- [x] **Code Quality Standards**: Type hints for all new functions, specific exception handling, no hardcoded paths
- [x] **Testing Discipline**: E2E tests for shared storage deployment modes, file locking edge cases
- [x] **User Experience Consistency**: Clear status messages during storage coordination, error guidance for lock failures
- [x] **Performance Requirements**: <3min unit addition (vs 5min baseline), <2min upgrade with shared binaries

**Complexity Justifications**:
- None required - implementation follows existing charm patterns with additional storage coordination logic

## Project Structure

### Documentation (this feature)

```text
specs/001-shared-storage/
├── spec.md              # Feature specification (already created)
├── plan.md              # This file (implementation plan)
├── research.md          # Phase 0: Juju storage patterns, locking mechanisms
├── data-model.md        # Phase 1: Storage entities and state transitions
├── quickstart.md        # Phase 1: Deployment guide for shared storage
├── contracts/           # Phase 1: Storage coordinator interface
│   └── storage_lock.py  # Lock file contract specification
└── checklists/
    └── requirements.md  # Quality validation checklist (already created)
```

### Source Code (repository root)

```text
concourse-ci-machine/
├── src/
│   ├── charm.py                      # Main charm logic (modify: storage hooks)
│   └── folder_mount_manager.py       # (existing, no changes needed)
│
├── lib/
│   ├── concourse_common.py           # (modify: add storage coordination utils)
│   ├── concourse_installer.py        # (modify: detect existing binaries)
│   ├── concourse_web.py              # (modify: shared storage awareness)
│   ├── concourse_worker.py           # (modify: shared storage awareness)
│   ├── concourse_helper.py           # (existing, no changes needed)
│   └── storage_coordinator.py        # (NEW: file locking and coordination)
│
├── metadata.yaml                     # (modify: storage configuration)
├── config.yaml                       # (existing, no new config options)
│
└── tests/
    ├── unit/
    │   ├── test_storage_coordinator.py  # NEW: lock acquisition/release tests
    │   └── test_installer_shared.py     # NEW: binary detection logic tests
    │
    └── integration/  # Handled by existing .github/workflows/ci.yml
        └── (E2E tests will be added to CI workflow)
```

**Structure Decision**: Single project structure (Juju charm). The charm already uses a modular library approach in `lib/` with separate modules for web, worker, installer, and common utilities. This feature adds a new `storage_coordinator.py` module and modifies existing modules to add shared storage awareness. No changes to the overall project layout are required.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |

## Complexity Tracking

> **Note**: No constitution violations detected. This section documents design decisions for transparency.

| Design Decision | Rationale | Alternatives Considered |
|-----------------|-----------|-------------------------|
| Filesystem-based locking (fcntl) | Simple, POSIX-standard, no external dependencies | Distributed locks (Redis/etcd) - rejected due to operational complexity and "Out of Scope" constraint |
| Shared storage pool in metadata.yaml | Native Juju storage feature, well-supported | Manual symlinking across units - rejected due to fragility and manual intervention requirements |
| Detection before download | Reduces network usage, aligns with performance goals | Always download - rejected due to bandwidth waste and slower deployments |
| Per-unit worker directories | Maintains isolation, prevents state conflicts | Fully shared worker state - rejected due to concurrency risks and potential corruption |

---

# Phase 0: Research & Technology Investigation

**Goal**: Resolve technical unknowns and establish implementation patterns.

## Research Tasks

### R1: Juju Shared Storage Configuration

**Question**: How to configure Juju storage for multi-unit shared access?

**Research Focus**:
- metadata.yaml storage configuration options (`shared: true` parameter)
- Storage pool types supporting shared access (filesystem-based pools)
- Mount semantics across multiple units (read-write vs read-only)
- Storage lifecycle (attach/detach behavior during scale-up/down)

**Findings** (to be documented in research.md):
